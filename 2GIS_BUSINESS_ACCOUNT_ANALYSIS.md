# Анализ использования бизнес-аккаунта 2ГИС для парсинга

## Текущая ситуация

### Ограничения публичного API 2ГИС

**Проблема:** Публичный API 2ГИС (`https://public-api.reviews.2gis.com/3.0/branches/{branch_id}/reviews`) возвращает максимум **50 последних отзывов**, даже если у организации их 318 или больше.

**Текущий подход:** Парсер использует веб-скрапинг через Selenium для обхода этого ограничения.

---

## Возможности бизнес-аккаунта 2ГИС

### 1. API для разработчиков (Developer API)

**Что это:**
- Официальный API 2ГИС для разработчиков
- Требует регистрации и получения API-ключа
- Может предоставлять расширенные лимиты

**Преимущества:**
- ✅ Стабильный доступ к данным
- ✅ Структурированные JSON ответы
- ✅ Возможность получить больше отзывов (если API это поддерживает)
- ✅ Нет необходимости в Selenium/браузере
- ✅ Быстрее и надежнее, чем скрапинг

**Ограничения:**
- ⚠️ Нужно проверить, поддерживает ли API получение всех отзывов (не только 50)
- ⚠️ Могут быть лимиты на количество запросов
- ⚠️ Может быть платным для больших объемов

### 2. Бизнес-кабинет 2ГИС

**Что это:**
- Личный кабинет для управления информацией о компании
- Доступ к статистике и аналитике
- Возможность экспорта данных

**Преимущества:**
- ✅ Прямой доступ к данным своей компании
- ✅ Возможность экспорта отзывов
- ✅ Более точные данные

**Ограничения:**
- ⚠️ Доступ только к данным своей компании
- ⚠️ Не подходит для парсинга других компаний
- ⚠️ Может не иметь API для автоматизации

---

## Рекомендации

### Вариант 1: Использование Developer API (рекомендуется)

**Шаги:**
1. Зарегистрироваться в [2ГИС Developer Portal](https://dev.2gis.com/)
2. Получить API-ключ
3. Изучить документацию API для отзывов
4. Проверить лимиты на количество отзывов

**Реализация:**
- Создать новый класс `GisApiParser` для работы через API
- Добавить конфигурацию для API-ключа в `.env` или `config.json`
- Использовать HTTP-запросы вместо Selenium
- Обработать пагинацию через API (если доступна)

**Преимущества:**
- Быстрее и надежнее
- Меньше нагрузка на сервер
- Стабильнее, чем скрапинг

**Недостатки:**
- Нужно проверить, можно ли получить все отзывы через API
- Могут быть лимиты на запросы

### Вариант 2: Гибридный подход

**Идея:**
- Использовать API для получения базовой информации и первых 50 отзывов
- Использовать скрапинг для получения остальных отзывов (если API ограничен)

**Реализация:**
- Проверять, есть ли API-ключ в конфиге
- Если есть - использовать API для начальных данных
- Если API ограничен 50 отзывами - переключаться на скрапинг для остальных

### Вариант 3: Улучшение текущего скрапинга

**Если API не решает проблему:**
- Улучшить логику скроллинга (уже сделано)
- Увеличить таймауты ожидания
- Улучшить селекторы для поиска отзывов
- Добавить более агрессивную прокрутку

---

## Что нужно проверить

### 1. Документация 2ГИС Developer API

**Вопросы:**
- Есть ли endpoint для получения всех отзывов организации?
- Какие лимиты на количество отзывов в ответе?
- Есть ли пагинация в API?
- Какие лимиты на количество запросов в день/час?

**Ссылки:**
- [2ГИС Developer Portal](https://dev.2gis.com/)
- [Документация API](https://dev.2gis.com/api/)

### 2. Бизнес-кабинет 2ГИС

**Вопросы:**
- Есть ли возможность экспорта отзывов?
- Есть ли API для бизнес-кабинета?
- Можно ли получить доступ к отзывам через бизнес-кабинет программно?

---

## План действий

### Этап 1: Исследование (1-2 дня)

1. ✅ Зарегистрироваться в 2ГИС Developer Portal
2. ✅ Изучить документацию API для отзывов
3. ✅ Проверить лимиты и возможности API
4. ✅ Протестировать получение отзывов через API

### Этап 2: Реализация (2-3 дня)

1. ✅ Добавить конфигурацию для API-ключа
2. ✅ Создать класс `GisApiParser` или расширить `GisParser`
3. ✅ Реализовать получение отзывов через API
4. ✅ Добавить fallback на скрапинг, если API ограничен

### Этап 3: Тестирование (1-2 дня)

1. ✅ Протестировать на реальных данных
2. ✅ Сравнить результаты API vs скрапинг
3. ✅ Проверить производительность
4. ✅ Убедиться, что получаем все отзывы

---

## Пример реализации API-парсера

```python
import requests
from typing import Dict, List, Any

class GisApiParser:
    def __init__(self, api_key: str):
        self.api_key = api_key
        self.base_url = "https://catalog.api.2gis.com"
        self.reviews_url = "https://public-api.reviews.2gis.com/3.0"
    
    def get_branch_reviews(self, branch_id: str, page: int = 1, page_size: int = 50) -> Dict[str, Any]:
        """
        Получить отзывы филиала через API
        
        Args:
            branch_id: ID филиала в 2ГИС
            page: Номер страницы
            page_size: Размер страницы (максимум может быть ограничен)
        
        Returns:
            Словарь с отзывами и метаданными
        """
        url = f"{self.reviews_url}/branches/{branch_id}/reviews"
        params = {
            "key": self.api_key,
            "page": page,
            "page_size": page_size
        }
        
        response = requests.get(url, params=params)
        response.raise_for_status()
        return response.json()
    
    def get_all_reviews(self, branch_id: str) -> List[Dict[str, Any]]:
        """
        Получить все отзывы филиала (с пагинацией)
        
        Args:
            branch_id: ID филиала в 2ГИС
        
        Returns:
            Список всех отзывов
        """
        all_reviews = []
        page = 1
        
        while True:
            data = self.get_branch_reviews(branch_id, page=page)
            reviews = data.get("result", {}).get("items", [])
            
            if not reviews:
                break
            
            all_reviews.extend(reviews)
            
            # Проверяем, есть ли еще страницы
            total = data.get("result", {}).get("total", 0)
            if len(all_reviews) >= total:
                break
            
            page += 1
        
        return all_reviews
```

---

## Выводы

### Использование бизнес-аккаунта может помочь, если:

1. ✅ **API предоставляет доступ ко всем отзывам** (не только 50)
2. ✅ **API быстрее и надежнее**, чем скрапинг
3. ✅ **Нет жестких лимитов** на количество запросов

### Но может не решить проблему, если:

1. ❌ **API все равно ограничен 50 отзывами** (как публичный)
2. ❌ **API платный** и дороже, чем улучшение скрапинга
3. ❌ **API не предоставляет все нужные данные** (например, нет рейтингов)

### Рекомендация:

**Начать с исследования API:**
1. Зарегистрироваться в Developer Portal
2. Получить API-ключ
3. Протестировать получение отзывов
4. Сравнить с текущим скрапингом

**Если API решает проблему:**
- Реализовать API-парсер
- Использовать как основной метод
- Оставить скрапинг как fallback

**Если API не решает проблему:**
- Продолжить улучшение скрапинга
- Использовать бизнес-аккаунт для других целей (управление отзывами, статистика)

---

## Следующие шаги

1. **Исследовать 2ГИС Developer API:**
   - Зарегистрироваться: https://dev.2gis.com/
   - Изучить документацию по отзывам
   - Получить тестовый API-ключ

2. **Протестировать API:**
   - Проверить, можно ли получить все отзывы
   - Проверить лимиты и пагинацию
   - Сравнить с результатами скрапинга

3. **Принять решение:**
   - Если API решает проблему - реализовать API-парсер
   - Если нет - продолжить улучшение скрапинга





