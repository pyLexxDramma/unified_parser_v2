<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏</title>
    <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}">
</head>
<body>
<div class="container task-page">
    <header class="task-header">
        <a href="/" class="link-back">‚Üê –ù–∞–∑–∞–¥ –∫ —Ñ–æ—Ä–º–µ</a>
        <h1>–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏</h1>
        {% if task %}
        <div class="status-row">
            <span class="status-chip status-{{ task.status.lower() if task.status else 'unknown' }}">{{ task.status or 'UNKNOWN' }}</span>
            <span class="task-id">ID: {{ task.task_id }}</span>
        </div>
        {% if task.error %}
            <p class="task-error">–û—à–∏–±–∫–∞: {{ task.error }}</p>
        {% endif %}
        {% else %}
        <div class="status-row">
            <span class="status-chip status-unknown">NOT FOUND</span>
            <span class="task-id">ID: {{ task_id if task_id else 'N/A' }}</span>
        </div>
        {% if error %}
            <p class="task-error">–û—à–∏–±–∫–∞: {{ error }}</p>
        {% endif %}
        {% endif %}
        
        <!-- –û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Å —Ç–µ–∫—Å—Ç–æ–º —Å—Ç–∞—Ç—É—Å–∞ -->
        <div class="progress-container" id="progress-container" style="margin-top: 15px; {% if task.status == 'RUNNING' or task.status == 'PENDING' %}display: block;{% else %}display: none;{% endif %}">
            <div class="progress-status-text" id="progress-status-text" style="margin-bottom: 10px; font-size: 0.95em; color: #555; min-height: 1.5em;">{{ task.progress or '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...' }}</div>
            <div class="progress-bar-wrapper" style="position: relative; width: 100%; background-color: #f0f0f0; border-radius: 8px; overflow: hidden; height: 24px;">
                <div class="progress-bar-fill" id="progress-bar-fill" style="height: 100%; background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%); width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.85em;"></div>
            </div>
        </div>
        
        <!-- –í—Ä–µ–º—è –ø–∞—Ä—Å–∏–Ω–≥–∞ -->
        <div class="time-info" style="margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px; font-size: 0.9em;">
            {% if task.start_time %}
                <div><strong>–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞:</strong> {{ task.start_time.strftime('%d.%m.%Y %H:%M:%S') if task.start_time else '‚Äî' }}</div>
            {% elif task.timestamp %}
                <div><strong>–°–æ–∑–¥–∞–Ω–æ:</strong> {{ task.timestamp.strftime('%d.%m.%Y %H:%M:%S') if task.timestamp else '‚Äî' }}</div>
            {% endif %}
            {% if task.end_time %}
                <div><strong>–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è:</strong> {{ task.end_time.strftime('%d.%m.%Y %H:%M:%S') if task.end_time else '‚Äî' }}</div>
            {% endif %}
            {% if task.start_time %}
                <div><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> 
                    <span id="duration-display">
                        {% if task.end_time and task.start_time %}
                            {% set duration = task.end_time - task.start_time %}
                            {% set total_paused = task.total_paused_duration if task.total_paused_duration else 0 %}
                            {% set actual_duration = duration.total_seconds() - total_paused %}
                            {{ (actual_duration // 60)|int }} –º–∏–Ω. {{ (actual_duration % 60)|int }} —Å–µ–∫.
                            {% if total_paused > 0 %}
                                <span style="color: #666; font-size: 0.9em;">(–ø–∞—É–∑–∞: {{ (total_paused // 60)|int }} –º–∏–Ω. {{ (total_paused % 60)|int }} —Å–µ–∫.)</span>
                            {% endif %}
                        {% elif task.start_time %}
                            <span id="live-duration">–í—ã—á–∏—Å–ª—è–µ—Ç—Å—è...</span>
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </span>
                </div>
            {% endif %}
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á) -->
        {% if task.status == 'RUNNING' or task.status == 'PENDING' %}
        <div class="control-buttons" style="margin-top: 15px; display: flex; gap: 10px;">
            <button id="btn-pause" class="btn-control btn-pause" onclick="pauseTask('{{ task.task_id }}')" style="padding: 10px 20px; background: #ff9800; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">‚è∏ –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            <button id="btn-stop" class="btn-control btn-stop" onclick="stopTask('{{ task.task_id }}')" style="padding: 10px 20px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        </div>
        {% elif task.status == 'PAUSED' %}
        <div class="control-buttons" style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px;">
            <button id="btn-resume" class="btn-control btn-resume" onclick="resumeTask('{{ task.task_id }}')" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">‚ñ∂ –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å</button>
            <button id="btn-stop" class="btn-control btn-stop" onclick="stopTask('{{ task.task_id }}')" style="padding: 10px 20px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            {% if task.detailed_results and task.detailed_results|length > 0 %}
            <button id="btn-show-results" class="btn-control btn-show-results" onclick="showResults()" style="padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">üìä –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã ({{ task.detailed_results|length }})</button>
            {% endif %}
            <button id="btn-restart" class="btn-control btn-restart" onclick="restartParsing('{{ task.task_id }}')" style="padding: 10px 20px; background: #9C27B0; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥</button>
        </div>
        {% endif %}
    </header>

    <section class="task-meta">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–∏—Å–∫–∞</h2>
        <div class="meta-grid">
            <div>
                <span class="meta-label">–ö–æ–º–ø–∞–Ω–∏—è</span>
                <span class="meta-value">{{ task.source_info.company_name if task.source_info else "‚Äî" }}</span>
            </div>
            <div>
                <span class="meta-label">–°–∞–π—Ç</span>
                <span class="meta-value">{{ task.source_info.company_site if task.source_info else "‚Äî" }}</span>
            </div>
            <div>
                <span class="meta-label">–ò—Å—Ç–æ—á–Ω–∏–∫</span>
                <span class="meta-value">{{ (task.source_info.source|upper) if task.source_info and task.source_info.source else "‚Äî" }}</span>
            </div>
            <div>
                <span class="meta-label">–û–±–ª–∞—Å—Ç—å –ø–æ–∏—Å–∫–∞</span>
                <span class="meta-value">
                    {% if task.source_info and task.source_info.search_scope == "city" %}
                        –ì–æ—Ä–æ–¥: {{ task.source_info.location or "–Ω–µ —É–∫–∞–∑–∞–Ω–æ" }}
                    {% elif task.source_info and task.source_info.search_scope == "country" %}
                        –°—Ç—Ä–∞–Ω–∞ / –æ–±—â–∏–π –ø–æ–∏—Å–∫
                        {% if task.source_info.cities %}
                            ‚Äî –≥–æ—Ä–æ–¥–∞:
                            {{ task.source_info.cities|replace(';', ', ') }}
                        {% endif %}
                    {% else %}
                        –°—Ç—Ä–∞–Ω–∞ / –æ–±—â–∏–π –ø–æ–∏—Å–∫
                    {% endif %}
                </span>
            </div>
        </div>
    </section>

    <section class="task-summary">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2 style="margin: 0;">–ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏</h2>
            {% if task.status == 'COMPLETED' %}
                <a href="/tasks/{{ task.task_id }}/download-pdf" class="btn-download-pdf" style="padding: 10px 20px; background: #2196F3; color: white; text-decoration: none; border-radius: 5px; font-weight: 600;">üì• –°–∫–∞—á–∞—Ç—å PDF –æ—Ç—á–µ—Ç</a>
            {% endif %}
        </div>
        {% if statistics %}
            {% set company_name = task.source_info.get('company_name', '–ö–æ–º–ø–∞–Ω–∏—è') if task.source_info else '–ö–æ–º–ø–∞–Ω–∏—è' %}
            <div style="font-family: 'Roboto', sans-serif; font-size: 18px; color: #333; line-height: 1.6;">
                <h2 style="color:#2F80ED;">{{ company_name }}</h2>
                
                {% if statistics.get('yandex') %}
                    {% set yandex_stats = statistics.get('yandex') %}
                    {% set y_neg = yandex_stats.get('aggregated_negative_reviews', 0) %}
                    {% set y_pos = yandex_stats.get('aggregated_positive_reviews', 0) %}
                    {% set y_neu = yandex_stats.get('aggregated_neutral_reviews', 0) %}
                    {% set y_rated = y_neg + y_neu + y_pos %}
                    {% set y_ans = yandex_stats.get('aggregated_answered_reviews_count', 0) %}
                    {% set y_total = yandex_stats.get('aggregated_reviews_count', 0) %}
                    {% set y_ans_percent = (y_ans * 100 / y_total) if y_total > 0 else 0 %}
                    <p><strong>–Ø–Ω–¥–µ–∫—Å:</strong></p>
                    <ul style="list-style-type: none; padding-left: 0; margin-bottom: 1rem;">
                        <li>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫: <span style="color:#FFC107;">{{ yandex_stats.get('total_cards_found', 0) }}</span></li>
                        <li>–û–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥: <span style="color:#FFC107;">{{ "%.1f"|format(yandex_stats.get('aggregated_rating', 0)) }} {% if yandex_stats.get('aggregated_rating', 0) >= 4 %}‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ{% elif yandex_stats.get('aggregated_rating', 0) >= 3 %}‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ{% elif yandex_stats.get('aggregated_rating', 0) >= 2 %}‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ{% elif yandex_stats.get('aggregated_rating', 0) >= 1 %}‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ{% else %}‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ{% endif %}</span></li>
                        <li>–í—Å–µ–≥–æ –æ—Ç–∑—ã–≤–æ–≤: <span style="color:#FFC107;">{{ yandex_stats.get('aggregated_reviews_count', 0) }}</span></li>
                        <li>–° –æ—Ü–µ–Ω–∫–æ–π (>0): <span style="color:#FFC107;">{{ y_rated }}</span></li>
                        <li>–û—Ç–≤–µ—á–µ–Ω–æ –Ω–∞: <span style="color:#FFC107;">{{ y_ans }}{% if y_total > 0 %} ({{ "%.0f"|format(y_ans_percent) }}%){% endif %}</span></li>
                        <li>–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞: 
                            <span style="color:#FFC107;">
                                {% if yandex_stats.get('aggregated_avg_response_time', 0) > 0 %}
                                    {% if yandex_stats.get('aggregated_avg_response_time', 0) < 7 %}
                                        {{ "%.0f"|format(yandex_stats.get('aggregated_avg_response_time', 0)) }} –¥–Ω–µ–π
                                    {% elif yandex_stats.get('aggregated_avg_response_time', 0) < 30 %}
                                        1 –Ω–µ–¥–µ–ª—è
                                    {% else %}
                                        1 –º–µ—Å—è—Ü
                                    {% endif %}
                                {% elif y_ans > 0 %}
                                    –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ ‚Äî –Ø–Ω–¥–µ–∫—Å –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∞—Ç—É –æ—Ç–≤–µ—Ç–∞, –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–π—Ç–µ—Å—å –ø–æ –¥–æ–ª–µ –æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö
                                {% else %}
                                    ‚Äî
                                {% endif %}
                            </span>
                        </li>
                        <li>–ù–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤ (1‚Äì2‚≠ê, —Å—Ä–µ–¥–∏ –æ—Ü–µ–Ω—ë–Ω–Ω—ã—Ö): <span style="color:#FFC107;">{{ y_neg }}</span></li>
                        <li>–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤ (3‚≠ê, —Å—Ä–µ–¥–∏ –æ—Ü–µ–Ω—ë–Ω–Ω—ã—Ö): <span style="color:#FFC107;">{{ y_neu }}</span></li>
                        <li>–ü–æ–∑–∏—Ç–∏–≤–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤ (4‚Äì5‚≠ê, —Å—Ä–µ–¥–∏ –æ—Ü–µ–Ω—ë–Ω–Ω—ã—Ö): <span style="color:#FFC107;">{{ y_pos }}</span></li>
                    </ul>
                {% endif %}
                
                {% if statistics.get('2gis') %}
                    {% set gis_stats = statistics.get('2gis') %}
                    <p><strong>2–ì–ò–°:</strong></p>
                    <ul style="list-style-type: none; padding-left: 0; margin-bottom: 1rem;">
                        <li>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫: <span style="color:#FFC107;">{{ gis_stats.get('total_cards_found', 0) }}</span></li>
                        <li>–û–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥ (–ø—Ä–∏–º–µ—Ä–Ω—ã–π): <span style="color:#FFC107;">{% if gis_stats.get('aggregated_rating', 0) and gis_stats.get('aggregated_rating', 0) > 0 %}{{ "%.1f"|format(gis_stats.get('aggregated_rating', 0)) }} {% if gis_stats.get('aggregated_rating', 0) >= 4 %}‚òÖ‚òÖ‚òÖ‚òÖ{% elif gis_stats.get('aggregated_rating', 0) >= 3 %}‚òÖ‚òÖ‚òÖ{% elif gis_stats.get('aggregated_rating', 0) >= 2 %}‚òÖ‚òÖ{% elif gis_stats.get('aggregated_rating', 0) >= 1 %}‚òÖ{% endif %}{% else %}‚Äî{% endif %}</span></li>
                        <li>–í—Å–µ–≥–æ –æ—Ç–∑—ã–≤–æ–≤: <span style="color:#FFC107;">{{ gis_stats.get('aggregated_reviews_count', 0) }}</span></li>
                        <li>–û—Ç–≤–µ—á–µ–Ω–æ –Ω–∞: <span style="color:#FFC107;">{{ gis_stats.get('aggregated_answered_reviews_count', 0) }}</span></li>
                        <li>–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞: <span style="color:#FFC107;">{% if gis_stats.get('aggregated_avg_response_time', 0) > 0 %}{% if gis_stats.get('aggregated_avg_response_time', 0) < 7 %}{{ "%.0f"|format(gis_stats.get('aggregated_avg_response_time', 0)) }} –¥–Ω–µ–π{% elif gis_stats.get('aggregated_avg_response_time', 0) < 30 %}1 –Ω–µ–¥–µ–ª—è{% else %}1 –º–µ—Å—è—Ü{% endif %}{% else %}‚Äî{% endif %}</span></li>
                        {% set gis_neg = gis_stats.get('aggregated_negative_reviews', 0) %}
                        {% set gis_pos = gis_stats.get('aggregated_positive_reviews', 0) %}
                        <li>–ù–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤ (1‚Äì2‚≠ê, –æ—Ü–µ–Ω–æ—á–Ω–æ): <span style="color:#FFC107;">{{ gis_neg }}</span></li>
                        <li>–ü–æ–∑–∏—Ç–∏–≤–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤ (5‚≠ê, –æ—Ü–µ–Ω–æ—á–Ω–æ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º 2–ì–ò–°): <span style="color:#FFC107;">{{ gis_pos }}</span></li>
                    </ul>
                {% endif %}
            </div>
        {% else %}
            <p class="muted">–ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.</p>
        {% endif %}
    </section>

    <section class="task-cards">
        <div class="section-heading">
            <h2 id="results-section">–ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏</h2>
            <span class="badge">{{ cards|length if cards else 0 }}</span>
            <form method="get" style="margin-left:auto; font-size:0.85em; display:flex; align-items:center; gap:4px;">
                <label style="cursor:pointer;">
                    <input type="checkbox"
                           name="show_problem_cards"
                           value="1"
                           {% if show_problem_cards %}checked{% endif %}
                           onchange="this.form.submit()">
                    –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
                </label>
            </form>
        </div>

        {% if cards %}
            {% set yandex_cards = cards|selectattr('source', 'equalto', 'yandex')|list %}
            {% set gis_cards = cards|selectattr('source', 'equalto', '2gis')|list %}

            {% if show_problem_cards %}
                {% if yandex_cards %}
                    {# –¢–æ–ø-5 –Ω–∞–∏–±–æ–ª–µ–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ –¥–æ–ª–µ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤ #}
                    {% set yandex_with_neg = yandex_cards|selectattr('card_reviews_negative', 'gt', 0)|list %}
                    {% if yandex_with_neg %}
                        {% set sorted_neg = yandex_with_neg|sort(attribute='card_reviews_negative', reverse=true) %}
                        <div class="cards-source-section" style="margin-bottom: 25px;">
                            <h3 style="margin: 10px 0; color: #C62828;">‚ö† –°–∞–º—ã–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (–Ø–Ω–¥–µ–∫—Å)</h3>
                            <ul style="list-style:none; padding-left:0; margin:0;">
                                {% for card in sorted_neg[:5] %}
                                    {% set total = (card.get('card_reviews_count', 0) or 0) %}
                                    {% set neg = (card.get('card_reviews_negative', 0) or 0) %}
                                    {% set share = (neg * 100 / total) if total > 0 else 0 %}
                                    <li style="padding:6px 0; border-bottom:1px solid #eee;">
                                        <strong>{{ card.get('card_name') or "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è" }}</strong>
                                        <span style="color:#666;">‚Äî {{ card.get('card_address') or "–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω" }}</span><br/>
                                        <span style="font-size:0.9em; color:#555;">
                                            ‚≠ê {{ card.get('card_rating') or "‚Äî" }},
                                            üí¨ {{ total }},
                                            üò° –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö: {{ neg }} ({{ "%.0f"|format(share) }}%)
                                        </span>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    {# –¢–æ–ø-5 –∫–∞—Ä—Ç–æ—á–µ–∫ –±–µ–∑ –æ—Ç–≤–µ—Ç–æ–≤, –Ω–æ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º —á–∏—Å–ª–æ–º –æ—Ç–∑—ã–≤–æ–≤ #}
                    {% set yandex_no_answer = yandex_cards
                        |selectattr('card_reviews_count', 'gt', 0)
                        |selectattr('card_answered_reviews_count', 'equalto', 0)
                        |list %}
                    {% if yandex_no_answer %}
                        {% set sorted_noans = yandex_no_answer|sort(attribute='card_reviews_count', reverse=true) %}
                        <div class="cards-source-section" style="margin-bottom: 25px;">
                            <h3 style="margin: 10px 0; color: #F57C00;">üôà –ö–∞—Ä—Ç–æ—á–∫–∏ –±–µ–∑ –æ—Ç–≤–µ—Ç–æ–≤ (–Ø–Ω–¥–µ–∫—Å)</h3>
                            <ul style="list-style:none; padding-left:0; margin:0;">
                                {% for card in sorted_noans[:5] %}
                                    {% set total = (card.get('card_reviews_count', 0) or 0) %}
                                    <li style="padding:6px 0; border-bottom:1px solid #eee;">
                                        <strong>{{ card.get('card_name') or "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è" }}</strong>
                                        <span style="color:#666;">‚Äî {{ card.get('card_address') or "–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω" }}</span><br/>
                                        <span style="font-size:0.9em; color:#555;">
                                            ‚≠ê {{ card.get('card_rating') or "‚Äî" }},
                                            üí¨ {{ total }},
                                            üó® –æ—Ç–≤–µ—Ç–æ–≤: 0
                                        </span>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                {% endif %}

                {% if gis_cards %}
                    {# –¢–æ–ø-5 –Ω–∞–∏–±–æ–ª–µ–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ 2–ì–ò–° –ø–æ —á–∏—Å–ª—É –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤ #}
                    {% set gis_with_neg = gis_cards|selectattr('card_reviews_negative', 'gt', 0)|list %}
                    {% if gis_with_neg %}
                        {% set gis_sorted_neg = gis_with_neg|sort(attribute='card_reviews_negative', reverse=true) %}
                        <div class="cards-source-section" style="margin-bottom: 25px;">
                            <h3 style="margin: 10px 0; color: #8E24AA;">‚ö† –°–∞–º—ã–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (2–ì–ò–°)</h3>
                            <ul style="list-style:none; padding-left:0; margin:0;">
                                {% for card in gis_sorted_neg[:5] %}
                                    {% set total = (card.get('card_reviews_count', 0) or 0) %}
                                    {% set neg = (card.get('card_reviews_negative', 0) or 0) %}
                                    {% set share = (neg * 100 / total) if total > 0 else 0 %}
                                    <li style="padding:6px 0; border-bottom:1px solid #eee;">
                                        <strong>{{ card.get('card_name') or "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è" }}</strong>
                                        <span style="color:#666;">‚Äî {{ card.get('card_address') or "–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω" }}</span><br/>
                                        <span style="font-size:0.9em; color:#555;">
                                            ‚≠ê {{ card.get('card_rating') or "‚Äî" }},
                                            üí¨ {{ total }},
                                            üò° –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö: {{ neg }} ({{ "%.0f"|format(share) }}%)
                                        </span>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    {# –¢–æ–ø-5 –∫–∞—Ä—Ç–æ—á–µ–∫ 2–ì–ò–° –±–µ–∑ –æ—Ç–≤–µ—Ç–æ–≤, –Ω–æ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º —á–∏—Å–ª–æ–º –æ—Ç–∑—ã–≤–æ–≤ #}
                    {% set gis_no_answer = gis_cards
                        |selectattr('card_reviews_count', 'gt', 0)
                        |selectattr('card_answered_reviews_count', 'equalto', 0)
                        |list %}
                    {% if gis_no_answer %}
                        {% set gis_sorted_noans = gis_no_answer|sort(attribute='card_reviews_count', reverse=true) %}
                        <div class="cards-source-section" style="margin-bottom: 25px;">
                            <h3 style="margin: 10px 0; color: #F57C00;">üôà –ö–∞—Ä—Ç–æ—á–∫–∏ –±–µ–∑ –æ—Ç–≤–µ—Ç–æ–≤ (2–ì–ò–°)</h3>
                            <ul style="list-style:none; padding-left:0; margin:0;">
                                {% for card in gis_sorted_noans[:5] %}
                                    {% set total = (card.get('card_reviews_count', 0) or 0) %}
                                    <li style="padding:6px 0; border-bottom:1px solid #eee;">
                                        <strong>{{ card.get('card_name') or "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è" }}</strong>
                                        <span style="color:#666;">‚Äî {{ card.get('card_address') or "–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω" }}</span><br/>
                                        <span style="font-size:0.9em; color:#555;">
                                            ‚≠ê {{ card.get('card_rating') or "‚Äî" }},
                                            üí¨ {{ total }},
                                            üó® –æ—Ç–≤–µ—Ç–æ–≤: 0
                                        </span>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                {% endif %}
            {% endif %}

            {% if yandex_cards %}
                <div class="cards-source-section">
                    <h3 style="margin: 20px 0 10px 0; color: #1976D2;">üìå –Ø–Ω–¥–µ–∫—Å ({{ yandex_cards|length }})</h3>
                    {% set yandex_sorted = yandex_cards|sort(attribute='city') %}
                    {% for city_group in yandex_sorted|groupby('city') %}
                        {% set city_name = city_group.grouper or '–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω' %}
                        <h4 style="margin: 10px 0 6px 0; color: #555;">üèô {{ city_name }}</h4>
                        {% for card in city_group.list %}
                <details class="card-panel">
                    <summary>
                        <div>
                            <h3>{{ card.get('card_name') or "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è" }}</h3>
                            <p class="card-address">{{ card.get('card_address') or "–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω" }}</p>
                        </div>
                        <div class="card-summary-stats">
                            <span>‚≠ê {{ card.get('card_rating') or "‚Äî" }}</span>
                            <span>üí¨ {{ card.get('card_reviews_count') or 0 }}</span>
                            {% if card.get('card_response_status') %}
                                <span>üó® {{ card.get('card_response_status') }}</span>
                            {% endif %}
                        </div>
                    </summary>
                    <div class="card-details-grid">
                        <div>
                            <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {{ card.get('card_phone') or "‚Äî" }}</p>
                        </div>
                        <div>
                            <p><strong>–û—Ç–≤–µ—Ç—ã:</strong> 
                                {% if card.get('card_answered_reviews_count') is not none %}
                                    –û—Ç–≤–µ—á–µ–Ω–æ: {{ card.get('card_answered_reviews_count', 0) }} / {{ card.get('card_reviews_count', 0) }}
                                {% else %}
                                    {{ card.get('card_response_status') or "–Ω–µ —É–∫–∞–∑–∞–Ω–æ" }}
                                {% endif %}
                            </p>
                            <p><strong>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞:</strong>
                                {% if card.get('card_avg_response_time') %}
                                    {{ card.get('card_avg_response_time') }} –¥–Ω.
                                {% else %}
                                    ‚Äî
                                {% endif %}
                            </p>
                            <p><strong>–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤ (4‚Äì5‚≠ê):</strong> {{ card.get('card_reviews_positive') or 0 }}</p>
                            <p><strong>–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤ (3‚≠ê):</strong> {{ card.get('card_reviews_neutral') or 0 }}</p>
                            <p><strong>–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤ (1‚Äì2‚≠ê):</strong> {{ card.get('card_reviews_negative') or 0 }}</p>
                        </div>
                    </div>
                    {% set reviews = card.get('detailed_reviews') %}
                    {% if reviews %}
                        <div class="reviews-block">
                            <h4>–û—Ç–∑—ã–≤—ã ({{ reviews|length }})</h4>
                            <ul class="review-list" style="list-style: none; padding: 0;">
                                {% for review in reviews %}
                                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                            {% if review.review_rating and review.review_rating|float > 0 %}
                                                {% set rating = review.review_rating|float %}
                                                {% set stars = "" %}
                                                {% if rating >= 4.5 %}
                                                    {% set stars = "‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê" %}
                                                {% elif rating >= 4.0 %}
                                                    {% set stars = "‚≠ê‚≠ê‚≠ê‚≠ê" %}
                                                {% elif rating >= 3.5 %}
                                                    {% set stars = "‚≠ê‚≠ê‚≠ê" %}
                                                {% elif rating >= 3.0 %}
                                                    {% set stars = "‚≠ê‚≠ê‚≠ê" %}
                                                {% elif rating >= 2.5 %}
                                                    {% set stars = "‚≠ê‚≠ê" %}
                                                {% elif rating >= 2.0 %}
                                                    {% set stars = "‚≠ê‚≠ê" %}
                                                {% elif rating >= 1.5 %}
                                                    {% set stars = "‚≠ê" %}
                                                {% elif rating >= 1.0 %}
                                                    {% set stars = "‚≠ê" %}
                                                {% endif %}
                                                <span style="font-size: 1.1em;">{{ stars }}</span>
                                                <span style="font-size: 0.9em; color: #666;">({{ "%.1f"|format(rating) }})</span>
                                            {% endif %}
                                            {% if review.review_author %}
                                                <span style="font-size: 0.9em; color: #555; font-weight: 500;">{{ review.review_author }}</span>
                                            {% endif %}
                                            {% if review.review_date %}
                                                <span style="font-size: 0.85em; color: #888;">{{ review.review_date }}</span>
                                            {% endif %}
                                        </div>
                                        {% if review.review_text %}
                                            <p style="margin: 5px 0 0 0; color: #333; font-size: 0.95em;">{{ review.review_text }}</p>
                                        {% else %}
                                            <p style="margin: 5px 0 0 0; color: #777; font-size: 0.9em; font-style: italic;">–æ—Ç–∑—ã–≤ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞</p>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% elif card.get('card_reviews_count', 0) > 0 %}
                        <div class="reviews-block">
                            <p class="muted">–û—Ç–∑—ã–≤—ã –Ω–∞–π–¥–µ–Ω—ã ({{ card.get('card_reviews_count', 0) }}), –Ω–æ –¥–µ—Ç–∞–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.</p>
                        </div>
                    {% endif %}
                </details>
                {% endfor %}
                    {% endfor %}
                </div>
            {% endif %}
            
            {% if gis_cards %}
                <div class="cards-source-section">
                    <h3 style="margin: 20px 0 10px 0; color: #1976D2;">üìå 2GIS ({{ gis_cards|length }})</h3>
                    {% set gis_sorted = gis_cards|sort(attribute='city') %}
                    {% for city_group in gis_sorted|groupby('city') %}
                        {% set city_name = city_group.grouper or '–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω' %}
                        <h4 style="margin: 10px 0 6px 0; color: #555;">üèô {{ city_name }}</h4>
                        {% for card in city_group.list %}
                        <details class="card-panel">
                            <summary>
                                <div>
                                    <h3>{{ card.get('card_name') or "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è" }}</h3>
                                    <p class="card-address">{{ card.get('card_address') or "–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω" }}</p>
                                </div>
                                <div class="card-summary-stats">
                                    <span>‚≠ê {{ card.get('card_rating') or "‚Äî" }}</span>
                                    <span>üí¨ {{ card.get('card_reviews_count') or 0 }}</span>
                                    {% if card.get('card_response_status') %}
                                        <span>üó® {{ card.get('card_response_status') }}</span>
                                    {% endif %}
                                </div>
                            </summary>
                            <div class="card-details-grid">
                                <div>
                                    <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {{ card.get('card_phone') or "‚Äî" }}</p>
                                </div>
                                <div>
                                    <p><strong>–û—Ç–≤–µ—Ç—ã:</strong> 
                                        {% if card.get('card_answered_reviews_count') is not none %}
                                            –û—Ç–≤–µ—á–µ–Ω–æ: {{ card.get('card_answered_reviews_count', 0) }} / {{ card.get('card_reviews_count', 0) }}
                                        {% else %}
                                            {{ card.get('card_response_status') or "–Ω–µ —É–∫–∞–∑–∞–Ω–æ" }}
                                        {% endif %}
                                    </p>
                                    <p><strong>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞:</strong>
                                        {% if card.get('card_avg_response_time') %}
                                            {{ card.get('card_avg_response_time') }} –¥–Ω.
                                        {% else %}
                                            ‚Äî
                                        {% endif %}
                                    </p>
                                    <p><strong>–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤ (4‚Äì5‚≠ê):</strong> {{ card.get('card_reviews_positive') or 0 }}</p>
                                    <p><strong>–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤ (3‚≠ê):</strong> {{ card.get('card_reviews_neutral') or 0 }}</p>
                                    <p><strong>–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤ (1‚Äì2‚≠ê):</strong> {{ card.get('card_reviews_negative') or 0 }}</p>
                                </div>
                            </div>
                            {% set reviews = card.get('detailed_reviews') %}
                            {% if reviews %}
                                <div class="reviews-block">
                                    <h4>–û—Ç–∑—ã–≤—ã ({{ reviews|length }})</h4>
                                    <ul class="review-list" style="list-style: none; padding: 0;">
                                        {% for review in reviews %}
                                            <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                                    {% if review.review_rating and review.review_rating|float > 0 %}
                                                        {% set rating = review.review_rating|float %}
                                                        {% set stars = "" %}
                                                        {% if rating >= 4.5 %}
                                                            {% set stars = "‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê" %}
                                                        {% elif rating >= 4.0 %}
                                                            {% set stars = "‚≠ê‚≠ê‚≠ê‚≠ê" %}
                                                        {% elif rating >= 3.5 %}
                                                            {% set stars = "‚≠ê‚≠ê‚≠ê" %}
                                                        {% elif rating >= 3.0 %}
                                                            {% set stars = "‚≠ê‚≠ê‚≠ê" %}
                                                        {% elif rating >= 2.5 %}
                                                            {% set stars = "‚≠ê‚≠ê" %}
                                                        {% elif rating >= 2.0 %}
                                                            {% set stars = "‚≠ê‚≠ê" %}
                                                        {% elif rating >= 1.5 %}
                                                            {% set stars = "‚≠ê" %}
                                                        {% elif rating >= 1.0 %}
                                                            {% set stars = "‚≠ê" %}
                                                        {% endif %}
                                                        <span style="font-size: 1.1em;">{{ stars }}</span>
                                                        <span style="font-size: 0.9em; color: #666;">({{ "%.1f"|format(rating) }})</span>
                                                    {% endif %}
                                                    {% if review.review_author %}
                                                        <span style="font-size: 0.9em; color: #555; font-weight: 500;">{{ review.review_author }}</span>
                                                    {% endif %}
                                                    {% if review.review_date %}
                                                        <span style="font-size: 0.85em; color: #888;">{{ review.review_date }}</span>
                                                    {% endif %}
                                                </div>
                                                {% if review.review_text %}
                                                    <p style="margin: 5px 0 0 0; color: #333; font-size: 0.95em;">{{ review.review_text }}</p>
                                                {% else %}
                                                    <p style="margin: 5px 0 0 0; color: #777; font-size: 0.9em; font-style: italic;">–æ—Ç–∑—ã–≤ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞</p>
                                                {% endif %}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% elif card.get('card_reviews_count', 0) > 0 %}
                                <div class="reviews-block">
                                    <p class="muted">–û—Ç–∑—ã–≤—ã –Ω–∞–π–¥–µ–Ω—ã ({{ card.get('card_reviews_count', 0) }}), –Ω–æ –¥–µ—Ç–∞–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.</p>
                                </div>
                            {% endif %}
                        </details>
                        {% endfor %}
                    {% endfor %}
                </div>
            {% endif %}
            
            {% if not yandex_cards and not gis_cards %}
                <p class="muted">–ö–∞—Ä—Ç–æ—á–∫–∏ –µ—â—ë –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∏–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>
            {% endif %}
        {% else %}
            <p class="muted">–ö–∞—Ä—Ç–æ—á–∫–∏ –µ—â—ë –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∏–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>
        {% endif %}
    </section>

    <section class="task-files">
        <h2>–§–∞–π–ª—ã –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
        {% if task.result_file %}
            <p>CSV —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∫–∞–∫ <code>{{ task.result_file }}</code> –≤ –ø–∞–ø–∫–µ <code>{{ output_dir }}</code>.</p>
        {% else %}
            <p class="muted">–§–∞–π–ª —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–æ–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω.</p>
        {% endif %}
        {% if task.email %}
            <p>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞: <strong>{{ task.email }}</strong></p>
        {% endif %}
    </section>
</div>

<script>
    // –ü—Ä–µ—Ñ–∏–∫—Å –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –ø—É—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–Ω—É–∂–µ–Ω, –µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–∏—Å–∏—Ç –Ω–µ –Ω–∞ /, –∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ /parser)
    // FastAPI –ø—Ä–æ—Å—Ç–∞–≤–ª—è–µ—Ç root_path –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º --root-path
    window.ROOT_PATH = "{{ request.scope.get('root_path') if request and request.scope and request.scope.get('root_path') else '' }}";

    // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–µ–π (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏)
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –î–û –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è onclick
    // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ window
    window.pauseTask = function(taskId) {
        console.log('Pause task called for:', taskId);
        const base = window.ROOT_PATH || '';
        fetch(base + `/api/tasks/${taskId}/pause`, { 
            method: 'POST',
            credentials: 'include',  // –í–∞–∂–Ω–æ: –ø–µ—Ä–µ–¥–∞–µ–º cookies –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log('Pause response status:', response.status);
            if (!response.ok) {
                return response.json().then(err => {
                    console.error('Pause error:', err);
                    return Promise.reject(err);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Pause response data:', data);
            if (data.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –ø–∞—É–∑—ã
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É'));
            }
        })
        .catch(error => {
            console.error('Pause catch error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–¥–∞—á–∏: ' + (error.error || error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        });
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Å–µ–∫—Ü–∏–∏ —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏)
    window.showResults = function() {
        // –ò—â–µ–º —Å–µ–∫—Ü–∏—é —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–æ ID
        const resultsSection = document.getElementById('results-section');
        if (resultsSection) {
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            resultsSection.style.transition = 'background-color 0.3s';
            resultsSection.style.backgroundColor = '#e3f2fd';
            resultsSection.style.padding = '10px';
            resultsSection.style.borderRadius = '5px';
            setTimeout(() => {
                resultsSection.style.backgroundColor = '';
                resultsSection.style.padding = '';
                resultsSection.style.borderRadius = '';
            }, 2000);
        } else {
            // –ï—Å–ª–∏ ID –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—â–µ–º –ø–æ –∫–ª–∞—Å—Å—É
            const cardsSection = document.querySelector('.cards-source-section, .task-results');
            if (cardsSection) {
                cardsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                alert('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –µ—â–µ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ');
            }
        }
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞
    window.restartParsing = function(taskId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥? –¢–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞ –±—É–¥–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –∏ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ —Å —Ç–µ–º–∏ –∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.')) {
            return;
        }
        
        const base = window.ROOT_PATH || '';
        fetch(base + `/api/tasks/${taskId}/restart`, { 
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.new_task_id) {
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
                window.location.href = `/tasks/${data.new_task_id}`;
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' + (error.error || error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        });
    };
    
    window.resumeTask = function(taskId) {
        const base = window.ROOT_PATH || '';
        fetch(base + `/api/tasks/${taskId}/resume`, { 
            method: 'POST',
            credentials: 'include',  // –í–∞–∂–Ω–æ: –ø–µ—Ä–µ–¥–∞–µ–º cookies –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => Promise.reject(err));
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ' + (error.error || error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        });
    };
    
    window.stopTask = function(taskId) {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥?')) {
            const base = window.ROOT_PATH || '';
            fetch(base + `/api/tasks/${taskId}/stop`, { 
                method: 'POST',
                credentials: 'include',  // –í–∞–∂–Ω–æ: –ø–µ—Ä–µ–¥–∞–µ–º cookies –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ alert, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                    const statusText = document.getElementById('progress-status-text');
                    if (statusText) {
                        statusText.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞... –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...';
                        statusText.style.color = '#ff9800';
                    }
                    
                    // –ù–∞—á–∏–Ω–∞–µ–º polling —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
                    let pollCount = 0;
                    const maxPolls = 60; // –ú–∞–∫—Å–∏–º—É–º 60 –ø—Ä–æ–≤–µ—Ä–æ–∫ (5 –º–∏–Ω—É—Ç)
                    const pollInterval = 5000; // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
                    
                    const pollStatus = function() {
                        pollCount++;
                        if (pollCount > maxPolls) {
                            // –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
                            if (statusText) {
                                statusText.textContent = '–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...';
                            }
                            setTimeout(function() {
                                location.reload();
                            }, 2000);
                            return;
                        }
                        
                        fetch(base + `/api/task_status/${taskId}`, {
                            method: 'GET',
                            credentials: 'include',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => response.json())
                        .then(taskData => {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å –ª–∏ –∑–∞–¥–∞—á–∞
                            if (taskData.status === 'COMPLETED' || taskData.status === 'FAILED') {
                                // –ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                                if (statusText) {
                                    statusText.textContent = '–ü–∞—Ä—Å–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...';
                                    statusText.style.color = '#4CAF50';
                                }
                                setTimeout(function() {
                                    location.reload();
                                }, 1500);
                            } else {
                                // –ó–∞–¥–∞—á–∞ –µ—â–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º polling
                                if (statusText) {
                                    statusText.textContent = `–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞... –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (${pollCount * 5} —Å–µ–∫)...`;
                                }
                                setTimeout(pollStatus, pollInterval);
                            }
                        })
                        .catch(error => {
                            console.error('Error polling task status:', error);
                            // –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º polling
                            setTimeout(pollStatus, pollInterval);
                        });
                    };
                    
                    // –ù–∞—á–∏–Ω–∞–µ–º polling —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                    setTimeout(pollStatus, 3000);
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–¥–∞—á–∏: ' + (error.error || error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            });
        }
    };
    
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    (function() {
        const progressText = '{{ task.progress or "" }}';
        if (progressText) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ task_status.js –µ—Å–ª–∏ –æ–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
            if (typeof updateProgressStages === 'function') {
                updateProgressStages(progressText);
            } else {
                // –ò–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä—É—á–Ω—É—é
                const progressStatusText = document.getElementById('progress-status-text');
                const progressBarFill = document.getElementById('progress-bar-fill');
                if (progressStatusText) {
                    progressStatusText.textContent = progressText;
                }
                // –ü—Ä–æ—Å—Ç–∞—è –æ—Ü–µ–Ω–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                let progressPercent = 0;
                if (progressText.includes('–∑–∞–≤–µ—Ä—à–µ–Ω–∞') || progressText.includes('completed')) {
                    progressPercent = 100;
                } else if (progressText.includes('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ') || progressText.includes('Scanning')) {
                    progressPercent = 66;
                } else if (progressText.includes('–ü–æ–∏—Å–∫') || progressText.includes('Searching') || progressText.includes('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è')) {
                    progressPercent = 33;
                }
                if (progressBarFill) {
                    progressBarFill.style.width = `${progressPercent}%`;
                    progressBarFill.textContent = progressPercent > 0 ? `${progressPercent}%` : '';
                }
            }
        }
    })();
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á —Å —É—á–µ—Ç–æ–º –ø–∞—É–∑—ã
    {% if task.start_time and not task.end_time %}
    (function() {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º UNIX-–º–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ (UTC), —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–º–µ—â–µ–Ω–∏—è –∏–∑-–∑–∞ —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞/—Å–µ—Ä–≤–µ—Ä–∞
        const startTimestampMs = {{ (task.start_time.timestamp() * 1000)|int if task.start_time else 0 }};
        const totalPausedDuration = {{ task.total_paused_duration if task.total_paused_duration else 0 }};
        const pauseStartTimestampMs = {% if task.pause_start_time %}{{ (task.pause_start_time.timestamp() * 1000)|int }}{% else %}0{% endif %};
        const isPaused = '{{ task.status }}' === 'PAUSED';
        
        function updateDuration() {
            if (!startTimestampMs) return;
            
            const nowMs = Date.now();
            let diff = Math.floor((nowMs - startTimestampMs) / 1000); // —Ä–∞–∑–Ω–∏—Ü–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
            
            // –í—ã—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ –≤—Ä–µ–º—è –ø–∞—É–∑—ã
            let currentPausedTime = totalPausedDuration;
            
            // –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ —Å–µ–π—á–∞—Å –Ω–∞ –ø–∞—É–∑–µ, –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –ø–∞—É–∑—ã
            if (isPaused && pauseStartTimestampMs) {
                const nowPauseMs = Date.now();
                currentPausedTime += Math.floor((nowPauseMs - pauseStartTimestampMs) / 1000);
            }
            
            diff = Math.max(0, diff - currentPausedTime);
            const minutes = Math.floor(diff / 60);
            const seconds = diff % 60;
            const durationEl = document.getElementById('live-duration');
            if (durationEl) {
                durationEl.textContent = `${minutes} –º–∏–Ω. ${seconds} —Å–µ–∫.`;
            }
        }
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
        setInterval(updateDuration, 1000);
        updateDuration(); // –ü–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ä–∞–∑—É
    })();
    {% endif %}
</script>
<script src="{{ url_for('static', path='task_status.js') }}"></script>
</body>
</html>







