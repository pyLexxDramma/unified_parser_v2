name: Deploy to Test Server

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

env:
  DOCKER_IMAGE_NAME: unified-parser
  DOCKER_COMPOSE_FILE: docker-compose.yml

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub (if needed)
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
      continue-on-error: true

    - name: Build Docker image
      run: |
        docker build -t ${{ env.DOCKER_IMAGE_NAME }}:latest .

    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          cd ${{ secrets.DEPLOY_PATH || '/opt/unified_parser' }}
          
          # Создаем директории если их нет
          mkdir -p output logs config nginx/conf.d
          
          # Останавливаем старые контейнеры
          docker-compose down || true
          
          # Удаляем старый образ (опционально)
          docker rmi ${{ env.DOCKER_IMAGE_NAME }}:latest || true
          
          # Копируем файлы (если нужно)
          # Здесь можно добавить копирование конфигов, если они не в репозитории
          
          # Запускаем новые контейнеры
          docker-compose up -d --build
          
          # Очищаем старые образы
          docker system prune -f

    - name: Health check
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          sleep 10
          curl -f http://localhost:8000/login || exit 1
