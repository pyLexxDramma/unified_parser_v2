# Итоговый анализ проблем парсера Яндекс.Карт и 2ГИС

## Дата анализа: 11.12.2025

## Резюме

Парсер не может извлечь точные данные и нужное количество отзывов и карточек по следующим причинам:

---

## 1. Проблемы с 2ГИС

### 1.1. Ограничение API 2ГИС (50 отзывов)

**Проблема:** Публичный API 2ГИС (`https://public-api.reviews.2gis.com/3.0/branches/{branch_id}/reviews`) возвращает максимум **50 последних отзывов**, даже если у организации их 318 или больше.

**Причина:** Это техническое ограничение публичного API 2ГИС. Для получения всех отзывов требуется:
- Личный кабинет разработчика с API-ключом
- Использование платного API с расширенными лимитами
- Или парсинг через веб-интерфейс (что мы и делаем)

**Вывод:** Использование API не решает проблему получения всех отзывов.

### 1.2. Проблема с прокруткой отзывов 2ГИС

**Из логов:**
```
Expected total reviews count: 318
Starting scroll to load all reviews... (expected: 318)
New reviews found! Total: 50 / 318
Scroll completed after 100 iterations. Found 50 reviews.
Found 50 review elements after scroll on first page
Page: found 50 elements, processed 50, skipped 33, added 17 reviews
High skip rate: 33/50 elements skipped. This might indicate overly aggressive filtering.
```

**Проблемы:**

1. **Прокрутка останавливается раньше времени:**
   - Ожидается 318 отзывов
   - Прокрутка останавливается после 100 итераций, найдено только 50 элементов
   - Условие остановки: `no_change_count >= required_no_change` (10 итераций без изменений)
   - Но 2ГИС загружает отзывы порциями по 50, и между порциями может быть задержка

2. **Слишком агрессивная фильтрация:**
   - Из 50 найденных элементов пропускается 33 (66%!)
   - Остается только 17 валидных отзывов
   - Причина: фильтры отсеивают элементы, которые на самом деле являются отзывами

3. **Проблема с пагинацией:**
   - Парсер находит ссылки на страницы пагинации, но:
     - После клика на "Показать еще" / "Загрузить еще" новые отзывы не загружаются
     - Или загружаются, но не распознаются селекторами
   - Логи показывают: `Clicked 'load more' / 'next page' button to load more reviews`, но затем прокрутка останавливается

**Технические причины:**

1. **Динамическая загрузка контента:**
   - 2ГИС использует бесконечную прокрутку (infinite scroll)
   - Отзывы загружаются через AJAX/XHR при прокрутке
   - Между загрузками порций может быть задержка 2-5 секунд
   - Парсер может не дождаться загрузки следующей порции

2. **Селекторы элементов:**
   - Селекторы `div._1k5soqfl`, `[data-review-id]` могут не находить все элементы
   - 2ГИС может использовать разные классы для разных типов отзывов
   - Элементы могут быть скрыты или не полностью загружены

3. **Фильтрация ложных срабатываний:**
   - Фильтры отсеивают элементы, которые выглядят как отзывы, но на самом деле являются:
     - Навигационными элементами
     - Кнопками "Читать целиком"
     - Ответами компании (которые мы уже фильтруем отдельно)
   - Но также могут отсеивать валидные отзывы с коротким текстом или без рейтинга

### 1.3. Проблема с количеством карточек 2ГИС

**Из логов:**
```
Found 1 links with /firm/ or /station/ in href
Filtered 1 2GIS cards to 1 card(s) matching company name 'Смарт Хоум'
```

**Проблема:** Найдена только 1 карточка, хотя может быть больше филиалов/точек.

**Причины:**
- Поиск 2ГИС может возвращать только главную карточку организации
- Филиалы могут быть объединены в одну карточку
- Или поисковый запрос слишком специфичен и находит только одну карточку

---

## 2. Проблемы с Яндекс.Картами

### 2.1. Неверное количество отзывов

**Из логов:**
```
Found reviews count 210 using selector: div.tabs-select-view__counter
Total reviews found on page: 210
```

**Но в CSV:** Только 17 отзывов для карточки Яндекс.

**Проблемы:**

1. **Парсер находит правильное количество (210), но извлекает только часть:**
   - Возможно, не все отзывы прокручиваются
   - Или фильтры отсеивают часть отзывов
   - Или отзывы загружаются на разных страницах пагинации, которые не обрабатываются

2. **Проблема с пагинацией отзывов Яндекс:**
   - Яндекс показывает отзывы с пагинацией (например, по 20-30 на страницу)
   - Парсер может обрабатывать только первую страницу
   - Или не находит/не кликает кнопки "Следующая страница"

### 2.2. Проблема с количеством карточек Яндекс

**Из логов:**
```
Found 0 new cards on page 2. Total: 4
```

**Проблема:** Найдено только 4 карточки, хотя может быть больше.

**Причины:**
- Поиск Яндекс может ограничивать количество результатов
- Прокрутка может останавливаться раньше времени
- Пагинация может не обрабатываться полностью

---

## 3. Общие проблемы

### 3.1. Ограничения веб-скрапинга

**Фундаментальные ограничения:**

1. **Динамический контент:**
   - Оба сервиса используют JavaScript для загрузки контента
   - Отзывы загружаются асинхронно через AJAX/XHR
   - Парсер должен ждать загрузки, но не всегда может определить, когда контент полностью загружен

2. **Защита от ботов:**
   - Яндекс и 2ГИС могут использовать:
     - Rate limiting (ограничение частоты запросов)
     - CAPTCHA
     - Обнаружение автоматизации (детекция Selenium)
   - Это может приводить к блокировкам или неполной загрузке данных

3. **Изменения верстки:**
   - Селекторы могут перестать работать при обновлении верстки
   - Классы CSS могут изменяться
   - Структура DOM может меняться

### 3.2. Технические ограничения парсера

1. **Таймауты:**
   - Парсер использует фиксированные таймауты (например, 5 минут для прокрутки)
   - Но для 318 отзывов может потребоваться больше времени
   - Или сервис может замедлять загрузку при обнаружении автоматизации

2. **Условия остановки прокрутки:**
   - Парсер останавливается, если количество отзывов не меняется 10 итераций подряд
   - Но 2ГИС может загружать отзывы порциями с задержками между порциями
   - Это может приводить к преждевременной остановке

3. **Фильтрация элементов:**
   - Фильтры могут быть слишком строгими
   - Элементы с коротким текстом или без рейтинга могут отсеиваться
   - Но они могут быть валидными отзывами

---

## 4. Сравнение с ТЗ

### Требования ТЗ (из YANDEX_2GIS_DATA_LIMITS.md):

1. ✅ Количество найденных карточек — **частично работает**
2. ✅ Общий рейтинг компании — **работает**
3. ❌ Общее число отзывов — **не работает полностью** (находится меньше, чем есть)
4. ✅ Число отзывов с ответом и без — **работает**
5. ⚠️ Средняя скорость ответа — **работает частично** (только если есть даты)
6. ⚠️ Разделение отзывов по тональности — **работает для Яндекс, частично для 2ГИС**
7. ⚠️ Возможность просмотреть текст каждого отзыва — **работает частично** (не все отзывы извлекаются)

### Основные расхождения:

1. **Количество отзывов:**
   - **Ожидается:** Все отзывы (например, 318 для "Смарт Хоум")
   - **Получается:** Только часть (17 из 318 для 2ГИС, 17 из 210 для Яндекс)
   - **Причина:** Проблемы с прокруткой, пагинацией и фильтрацией

2. **Количество карточек:**
   - **Ожидается:** Все карточки организации
   - **Получается:** Только часть (1 для 2ГИС, 4 для Яндекс)
   - **Причина:** Ограничения поиска, неполная обработка пагинации

---

## 5. Рекомендации по улучшению

### 5.1. Для 2ГИС:

1. **Улучшить логику прокрутки:**
   - Увеличить таймаут ожидания между порциями отзывов (сейчас 0.3-0.5 сек, нужно 2-3 сек)
   - Увеличить `required_no_change` с 10 до 20-30 итераций
   - Добавить проверку на наличие кнопки "Показать еще" после каждой порции

2. **Улучшить фильтрацию:**
   - Ослабить фильтры для элементов с коротким текстом
   - Добавить больше селекторов для поиска отзывов
   - Улучшить логику определения валидности отзыва

3. **Улучшить обработку пагинации:**
   - Более агрессивный поиск и клик по кнопкам "Показать еще"
   - Обработка всех найденных страниц пагинации
   - Проверка, что новые отзывы действительно загрузились после клика

### 5.2. Для Яндекс:

1. **Улучшить обработку пагинации отзывов:**
   - Находить и обрабатывать все страницы пагинации
   - Убедиться, что все отзывы прокручиваются на каждой странице

2. **Улучшить обработку пагинации карточек:**
   - Обрабатывать все страницы результатов поиска
   - Улучшить логику определения конца списка карточек

### 5.3. Общие улучшения:

1. **Улучшить логирование:**
   - Добавить больше детальных логов о процессе прокрутки
   - Логировать причины пропуска элементов
   - Логировать время загрузки каждой порции данных

2. **Улучшить обработку ошибок:**
   - Обрабатывать случаи, когда контент не загружается
   - Повторять попытки при сбоях
   - Сохранять частичные результаты

3. **Рассмотреть альтернативные подходы:**
   - Использование официальных API (если доступны)
   - Использование headless браузеров с более продвинутой автоматизацией
   - Распределение нагрузки на несколько экземпляров парсера

---

## 6. Вывод

**Основная причина проблем:** Ограничения веб-скрапинга в сочетании с динамической загрузкой контента и защитой от ботов.

**Конкретные проблемы:**

1. **2ГИС:**
   - Прокрутка останавливается после 50 отзывов (из 318 ожидаемых)
   - Слишком агрессивная фильтрация (66% элементов пропускается)
   - Проблемы с обработкой пагинации и кнопок "Показать еще"

2. **Яндекс:**
   - Не все страницы пагинации отзывов обрабатываются
   - Не все карточки находятся из-за ограничений поиска

3. **API 2ГИС:**
   - Публичный API ограничен 50 отзывами
   - Для получения всех отзывов требуется платный API или веб-скрапинг

**Рекомендация:** Продолжить улучшение логики прокрутки и фильтрации, но также рассмотреть возможность использования официальных API с расширенными лимитами или комбинированный подход (API + веб-скрапинг).





