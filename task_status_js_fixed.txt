// Автоматическое обновление страницы при изменении статуса задачи
(function() {
    'use strict';
    
    // Получаем task_id из URL
    const pathParts = window.location.pathname.split('/');
    const taskId = pathParts[pathParts.length - 1];
    
    if (!taskId || taskId === 'tasks') {
        return; // Не страница задачи
    }
    
    // УБРАНО: проверка sessionStorage блокировала обновление статуса
    // Теперь статус будет обновляться всегда
    
    let checkInterval = null;
    let lastStatus = null;
    let hasReloaded = false;
    
    function checkTaskStatus() {
        const base = window.ROOT_PATH || '';
        fetch(base + `/api/task_status/${taskId}`, {
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch task status');
                }
                return response.json();
            })
            .then(data => {
                const currentStatus = data.status;
                
                // ВСЕГДА обновляем статус на странице, даже если он не изменился
                // Это важно для обновления прогресса
                updateStatusOnPage(data);
                
                // Если статус изменился на COMPLETED или FAILED, обновляем страницу только один раз
                if ((currentStatus === 'COMPLETED' || currentStatus === 'FAILED') && !hasReloaded) {
                    if (lastStatus !== currentStatus && lastStatus !== null) {
                        hasReloaded = true;
                        
                        // Останавливаем проверку перед обновлением
                        if (checkInterval) {
                            clearInterval(checkInterval);
                            checkInterval = null;
                        }
                        
                        // Обновляем страницу через небольшую задержку, чтобы пользователь увидел финальный статус
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                        return; // Выходим, чтобы не обновлять lastStatus
                    }
                } else if (currentStatus === 'COMPLETED' || currentStatus === 'FAILED') {
                    // Статус уже COMPLETED/FAILED, останавливаем проверку
                    if (checkInterval) {
                        clearInterval(checkInterval);
                        checkInterval = null;
                    }
                }
                
                lastStatus = currentStatus;
            })
            .catch(error => {
                console.error('Error checking task status:', error);
                // Показываем ошибку только если это не 404 (задача может быть еще не создана)
                if (error.message && !error.message.includes('404')) {
                    console.error('Failed to fetch task status:', error);
                }
            });
    }
    
    function updateStatusOnPage(data) {
        // Обновляем статус в заголовке
        const statusChip = document.querySelector('.status-chip');
        if (statusChip && data.status) {
            statusChip.textContent = data.status;
            statusChip.className = `status-chip status-${data.status.toLowerCase()}`;
        }
        
        // Обновляем прогресс (используем правильный селектор из HTML)
        const progressElement = document.getElementById('progress-status-text');
        if (progressElement) {
            // ВСЕГДА обновляем прогресс, даже если data.progress пустой
            progressElement.textContent = data.progress || 'Обработка...';
        }
        
        // Обновляем прогресс-бар с этапами
        updateProgressStages(data.progress || '');
        
        // Логируем для отладки
        console.log('Status updated:', data.status, 'Progress:', data.progress);
    }
    
    function updateProgressStages(progressText) {
        const progressContainer = document.getElementById('progress-container');
        const progressStatusText = document.getElementById('progress-status-text');
        const progressBarFill = document.getElementById('progress-bar-fill');
        
        if (!progressContainer || !progressStatusText || !progressBarFill) return;
        
        const statusChip = document.querySelector('.status-chip');
        const taskStatus = statusChip ? statusChip.textContent.trim().toUpperCase() : '';
        
        if (taskStatus === 'RUNNING' || taskStatus === 'PENDING') {
            progressContainer.style.display = 'block';
        } else {
            progressContainer.style.display = 'none';
            return;
        }
        
        if (!progressText) progressText = '';
        
        progressStatusText.textContent = progressText || 'Обработка...';
        
        let progressPercent = 0;
        
        const match = progressText.match(/(\d+)\s*[\/из]\s*(\d+)/);
        if (match) {
            const current = parseInt(match[1]);
            const total = parseInt(match[2]);
            progressPercent = total > 0 ? Math.round((current / total) * 100) : 0;
        } else if (progressText.includes('Агрегация') || progressText.includes('завершена') || progressText.includes('completed')) {
            progressPercent = 100;
        } else if (progressText.includes('Сканирование') || progressText.includes('Scanning')) {
            progressPercent = 66;
        } else if (progressText.includes('Поиск') || progressText.includes('Searching') || progressText.includes('Инициализация')) {
            progressPercent = 33;
        } else {
            const cardsMatch = progressText.match(/найдено\s+(\d+)/);
            if (cardsMatch) {
                progressPercent = 50;
            }
        }
        
        progressPercent = Math.min(100, Math.max(0, progressPercent));
        progressBarFill.style.width = `${progressPercent}%`;
        progressBarFill.textContent = progressPercent > 0 ? `${progressPercent}%` : '';
    }
    
    // Начинаем проверку статуса каждые 2 секунды (увеличена частота обновления)
    if (taskId) {
        console.log('Starting task status checker for task:', taskId);
        // Первая проверка сразу
        checkTaskStatus();
        // Устанавливаем интервал проверки
        checkInterval = setInterval(() => {
            console.log('Checking task status...');
            checkTaskStatus();
        }, 2000);
        console.log('Task status checker started, interval ID:', checkInterval);
    } else {
        console.warn('No task ID found, status checker not started');
    }
    
    // Останавливаем проверку при уходе со страницы
    window.addEventListener('beforeunload', () => {
        if (checkInterval) {
            clearInterval(checkInterval);
        }
    });
})();







