# Документация по фильтрам в парсерах Яндекс и 2ГИС

## Общие фильтры для обоих парсеров

### 1. Фильтрация карточек по названию компании

**Яндекс:**
- Метод: `_filter_cards_by_name()`
- Алгоритм: `_calculate_name_similarity()`
- Порог: >= 0.6 или в пределах 0.15 от лучшего совпадения
- Критерии:
  - Точное совпадение (1.0)
  - Подстрока (0.9 или 0.8)
  - Совпадение по словам (0.7 для подмножества, затем отношение общих слов)
  - Бонус за совпадение первого слова
  - Штраф за уникальные слова в названии карточки, которых нет в запросе

**2ГИС:**
- Метод: `_filter_cards_by_name()`
- Алгоритм: `_calculate_name_similarity()`
- Порог: >= 0.6 или в пределах 0.15 от лучшего совпадения
- Критерии: аналогичны Яндекс

---

## Фильтры отзывов в Яндекс парсере

### 1. Фильтр дубликатов отзывов
- **Механизм**: Используется `seen_review_keys` (set)
- **Ключ дубликата**: `f"{author_name}_{date_text}_{rating_value}_{hash(review_text[:50])[:10]}"`
- **Действие**: Если ключ уже существует, отзыв пропускается (`continue`)

### 2. Фильтр ответов компании
- **Проверка**: Анализ первых 200 символов текста отзыва
- **Критерии определения ответа компании**:
  - Начинается с "спасибо за ваш отзыв" или "благодарим вас за"
  - Начинается с "спасибо за ваш" + содержит "положительный"/"отрицательный"/"отзыв" в первых 60 символах
  - Начинается с "благодарим вас" или "благодарим за"
  - Начинается с "благодарим" + длина текста < 100 символов
  - Начинается с "добрый день" или "здравствуйте" + содержит слова: "наша", "поддержка", "обращайтесь", "рады", "стараемся", "команда", "техническая" в первых 150 символах
  - Содержит фразы в первых 100 символах: "наша техническая поддержка", "обращайтесь по телефону", "наша команда", "мы рады", "мы стараемся", "напишите на", "позвоните по"
- **Действие**: Отзыв пропускается (`continue`), логируется как "Found Yandex company response"

### 3. Фильтр минимального содержания
- **Условие**: `if review_text or rating_value > 0`
- **Действие**: Отзыв добавляется в `all_reviews` только если есть текст ИЛИ рейтинг > 0

### 4. Очистка служебных текстов
- **Удаляются**: "Подписаться", "Полезно?", "Полезно", "Подписаться Полезно?"
- **Действие**: Если весь текст состоит только из служебных слов, `review_text` очищается

### 5. Удаление префиксов
- Удаляется префикс "Имя Знаток города N уровня Подписаться ДД месяц YYYY"
- Удаляется ведущая дата "12 ноября 2025" или "12 ноября"

---

## Фильтры отзывов в 2ГИС парсере

### 1. Фильтр служебных элементов
- **Пропускаются элементы**, содержащие слова: "читать целиком", "показать еще", "следующая", "предыдущая", "страница"
- **Действие**: Элемент пропускается (`continue`)

### 2. Фильтр дубликатов отзывов
- **Механизм**: Используется `seen_review_keys` (set)
- **Ключ дубликата**: `f"{author_name}_{date_text}_{rating_value}_{hash(review_text[:50])[:10]}"`
- **Действие**: Если ключ уже существует, отзыв пропускается (`continue`), логируется как "Skipping duplicate review"

### 3. Фильтр ответов компании
- **Проверка**: Анализ первых 200 символов текста отзыва
- **Критерии определения ответа компании** (аналогичны Яндекс):
  - Начинается с "спасибо за ваш отзыв" или "благодарим вас за"
  - Начинается с "спасибо за ваш" + содержит "положительный"/"отрицательный"/"отзыв" в первых 60 символах
  - Начинается с "благодарим вас" или "благодарим за"
  - Начинается с "благодарим" + длина текста < 100 символов
  - Начинается с "добрый день" или "здравствуйте" + содержит слова: "наша", "поддержка", "обращайтесь", "рады", "стараемся", "команда", "техническая" в первых 150 символах
  - Содержит фразы в первых 100 символах: "наша техническая поддержка", "обращайтесь по телефону", "наша команда", "мы рады", "мы стараемся", "напишите на", "позвоните по"
- **Дополнительный критерий**: `has_response and rating_value == 0 and (not review_text or len(review_text) < 10)`
- **Действие**: Отзыв пропускается (`continue`), логируется как "Found company response (not a user review)"

### 4. Фильтр минимального содержания
- **Условие**: `if (review_text and len(review_text) >= 3) or rating_value > 0`
- **Действие**: Отзыв добавляется в `all_reviews` только если:
  - Есть текст длиной >= 3 символа ИЛИ
  - Рейтинг > 0

### 5. Фильтр элементов с классом "читать"
- **Пропускаются дочерние элементы** с классами, содержащими: "читать", "целиком", "показать", "еще", "load", "more"
- **Действие**: Элемент пропускается при извлечении текста

### 6. Очистка служебных текстов
- **Удаляются**: "Подписаться", "Полезно?", "Полезно", "Подписаться Полезно?"
- **Действие**: Если весь текст состоит только из служебных слов, `review_text` очищается

---

## Итоговая статистика фильтрации

### Яндекс:
- **Добавляется в `all_reviews`**: Отзывы с текстом ИЛИ рейтингом > 0, которые не являются дубликатами и не являются ответами компании
- **Пропускается**: Дубликаты, ответы компании, отзывы без текста и без рейтинга

### 2ГИС:
- **Добавляется в `all_reviews`**: Отзывы с текстом >= 3 символов ИЛИ рейтингом > 0, которые не являются дубликатами, не являются ответами компании и не являются служебными элементами
- **Пропускается**: Служебные элементы, дубликаты, ответы компании, отзывы без текста (или с текстом < 3 символов) и без рейтинга

---

## Логирование фильтрации

### Яндекс:
- `logger.debug(f"Found Yandex company response (not a user review): author={author_name}, text_preview={review_text[:50]}")` - при пропуске ответа компании

### 2ГИС:
- `logger.debug(f"Found company response (not a user review): author={author_name}, text_preview={review_text[:50]}")` - при пропуске ответа компании
- `logger.debug(f"Skipping duplicate review: key={review_key[:50]}")` - при пропуске дубликата (первые 20 или каждый 10-й)

